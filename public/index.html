<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的导航站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --glass-bg: rgba(255, 255, 255, 0.1); --glass-blur: blur(12px); }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; min-height: 100vh; }
        
        .bg-slide { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 1.5s; z-index: -2; }
        .bg-slide.active { opacity: 1; }
        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: -1; }

        .top-bar { position: fixed; top: 0; width: 100%; height: 64px; background: rgba(15,23,42,0.6); backdrop-filter: var(--glass-blur); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; z-index: 50; }
        
        .container { max-width: 1200px; margin: 100px auto 50px; padding: 0 20px; }
        
        .category-box { margin-bottom: 40px; animation: fadeIn 0.5s; }
        .cat-header { display: inline-flex; align-items: center; gap: 10px; padding: 8px 20px; background: rgba(255,255,255,0.05); border-radius: 30px; cursor: pointer; transition: 0.3s; }
        .cat-header:hover { background: rgba(255,255,255,0.15); }
        
        .cat-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 25px; padding: 25px 10px; transition: 0.5s; overflow: hidden; max-height: 2000px; }
        .cat-content.collapsed { max-height: 0; padding: 0; opacity: 0; }

        .site-item { display: flex; flex-direction: column; align-items: center; gap: 10px; text-decoration: none; color: white; }
        .site-circle { width: 80px; height: 80px; border-radius: 50%; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border: 1px solid rgba(255,255,255,0.2); display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .site-circle:hover { transform: scale(1.1); background: rgba(255,255,255,0.2); }
        .site-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .site-name { font-size: 0.8rem; opacity: 0.8; width: 120%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .icon-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.3s; }
        .icon-btn:hover { background: white; color: black; }
        .icon-btn.playing { animation: pulse 2s infinite; background: #10b981; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-box { background: #1e293b; width: 95%; max-width: 900px; max-height: 85vh; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #334155; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="slideshow"></div>
    <div class="bg-overlay"></div>

    <div class="top-bar">
        <div class="flex items-center gap-3">
            <img id="site-logo-img" src="" class="w-8 h-8 rounded-full border border-white/20 hidden">
            <span class="font-bold tracking-widest text-sm">PORTAL</span>
        </div>
        <div class="flex-1 mx-8 overflow-hidden text-center text-sm text-gray-300 whitespace-nowrap">
            <span id="welcome-text">Loading...</span>
        </div>
        <div class="flex items-center gap-3">
            <input id="search-input" placeholder="搜索..." class="bg-white/10 border border-white/20 rounded-full px-4 py-1 text-xs focus:bg-black/50 transition w-24 focus:w-40 text-white outline-none">
            <button id="music-btn" class="icon-btn" title="播放音乐"><i class="fas fa-music text-xs"></i></button>
            <button onclick="openAdmin()" class="icon-btn" title="私密空间"><i class="fas fa-shield-alt text-xs"></i></button>
        </div>
    </div>

    <div id="main-container" class="container"></div>

    <div id="admin-modal" class="modal">
        <div class="modal-box">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800">
                <h2 class="text-lg font-bold">管理后台</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="login-section" class="text-center py-10">
                    <input type="password" id="admin-pwd" class="bg-gray-700 p-2 rounded text-center text-white mb-4" placeholder="密码 (默认 Qq110110.)">
                    <br><button onclick="login()" class="bg-indigo-600 px-6 py-2 rounded font-bold">解锁</button>
                </div>

                <div id="admin-panel" class="hidden space-y-8">
                    <div class="grid grid-cols-2 gap-4 bg-gray-800 p-4 rounded-xl text-center">
                        <div><div class="text-xs text-gray-400">总访问</div><div id="stat-total" class="text-2xl font-bold">0</div></div>
                        <div><div class="text-xs text-gray-400">今日</div><div id="stat-today" class="text-2xl font-bold text-green-400">0</div></div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl"><div id="visitor-list" class="text-xs text-gray-400 space-y-1 font-mono"></div></div>

                    <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 space-y-3">
                        <h3 class="text-sm font-bold text-blue-400">全局设置</h3>
                        <input id="set-icon" class="w-full bg-gray-900 p-2 rounded text-sm" placeholder="网站头像 URL">
                        <input id="set-welcome" class="w-full bg-gray-900 p-2 rounded text-sm" placeholder="欢迎语">
                        <textarea id="set-bg" rows="3" class="w-full bg-gray-900 p-2 rounded text-sm" placeholder="背景图URL (每行一张)"></textarea>
                        <button onclick="saveSettings()" class="bg-blue-600 px-4 py-2 rounded text-sm w-full">保存设置</button>
                    </div>

                    <div class="bg-gray-800 p-5 rounded-xl border border-gray-700">
                        <h3 class="text-sm font-bold text-green-400 mb-3">音乐管理</h3>
                        <div class="flex gap-2 mb-3">
                            <input id="music-name" class="bg-gray-900 p-2 rounded flex-1 text-sm" placeholder="歌名">
                            <input id="music-url" class="bg-gray-900 p-2 rounded flex-1 text-sm" placeholder="MP3链接">
                            <button onclick="addMusic()" class="bg-green-600 px-4 rounded"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="music-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
                    </div>

                    <div class="bg-gray-800 p-5 rounded-xl border border-gray-700">
                        <h3 class="text-sm font-bold text-purple-400 mb-3">内容管理</h3>
                        <div class="flex gap-2 mb-4 bg-gray-900 p-2 rounded">
                            <input id="cat-name" class="bg-transparent flex-1 text-sm outline-none" placeholder="新分类名称">
                            <label class="flex items-center gap-1 text-xs text-yellow-500"><input type="checkbox" id="cat-private"> 私密</label>
                            <button onclick="addCategory()" class="bg-gray-700 px-3 rounded text-xs">添加分类</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
                            <select id="site-cat" class="bg-gray-900 p-2 rounded text-sm"></select>
                            <input id="site-name" class="bg-gray-900 p-2 rounded text-sm" placeholder="网站名称">
                            <input id="site-url" class="bg-gray-900 p-2 rounded text-sm md:col-span-2" placeholder="网址">
                            <input id="site-icon" class="bg-gray-900 p-2 rounded text-sm md:col-span-2" placeholder="图标URL (可选)">
                        </div>
                        <button onclick="addSite()" class="w-full bg-indigo-600 py-2 rounded text-sm font-bold">添加网站</button>
                        <div id="admin-site-list" class="space-y-2 mt-4 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="bg-audio" loop></audio>

    <script type="module">
        const ADMIN_PASS = "Qq110110."; 
        const state = { loggedIn: false, sites: [], cats: [], music: [], settings: {}, bgIdx: 0 };
        const $ = (id) => document.getElementById(id);
        const api = {
            get: async (ep) => (await fetch(`/api/${ep}`)).json(),
            post: async (ep, d) => (await fetch(`/api/${ep}`, { method:'POST', body:JSON.stringify(d) })).json(),
            del: async (ep) => (await fetch(`/api/${ep}`, { method:'DELETE' })).json()
        };

        async function init() {
            try {
                const [s, c, si, m, v] = await Promise.all([
                    api.get('settings'), api.get('categories'), api.get('sites'), api.get('custom-music'), api.get('visitor')
                ]);
                state.settings = s || {}; state.cats = c || []; state.sites = si || []; state.music = m || [];

                renderBackgrounds();
                renderMain();
                if(state.settings.welcomeMessage) $('welcome-text').innerText = state.settings.welcomeMessage;
                if(state.settings.siteIconUrl) { $('site-logo-img').src = state.settings.siteIconUrl; $('site-logo-img').classList.remove('hidden'); }
                if(v) { $('stat-total').innerText = v.total||0; $('stat-today').innerText = v.today||0; if(v.recent) renderVisitorList(v.recent); }
                
                initMusic();
                api.post('visitor', {}); 
            } catch(e) { console.error(e); }
        }

        function renderMain() {
            const box = $('main-container'); box.innerHTML = '';
            state.cats.forEach(cat => {
                if (!state.loggedIn && cat.is_private) return;
                const sites = state.sites.filter(s => s.categoryId == cat.id);
                const div = document.createElement('div');
                div.className = 'category-box fade-in';
                div.innerHTML = `
                    <div class="cat-header" onclick="this.nextElementSibling.classList.toggle('collapsed')">
                        <i class="fas fa-chevron-right text-xs transition-transform"></i>
                        <span class="font-bold ml-2">${cat.name}</span>${cat.is_private?'<i class="fas fa-lock text-yellow-500 text-xs ml-2"></i>':''}
                    </div>
                    <div class="cat-content">
                        ${sites.map(s => `
                            <a href="${s.url}" target="_blank" class="site-item group">
                                <div class="site-circle"><img src="${s.icon}" class="site-img" onerror="this.src='https://placehold.co/40'"></div>
                                <div class="site-name">${s.name}</div>
                            </a>`).join('')}
                    </div>`;
                box.appendChild(div);
            });
        }

        function renderBackgrounds() {
            let urls = []; try { urls = JSON.parse(state.settings.backgroundUrls||'[]'); } catch { urls = [state.settings.backgroundUrls]; }
            if(!urls.length) urls = ['https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=1920'];
            $('slideshow').innerHTML = urls.map((u,i)=>`<div class="bg-slide ${i===0?'active':''}" style="background-image:url('${u}')"></div>`).join('');
            if(urls.length>1) setInterval(()=>{
                const slides=document.querySelectorAll('.bg-slide');
                slides[state.bgIdx].classList.remove('active');
                state.bgIdx=(state.bgIdx+1)%slides.length;
                slides[state.bgIdx].classList.add('active');
            }, 8000);
        }

        function initMusic() {
            if(!state.music.length) return;
            const audio = $('bg-audio'), btn = $('music-btn');
            let idx = 0;
            const play = () => { audio.src = state.music[idx].url; audio.play().then(()=>btn.classList.add('playing')).catch(()=>{ document.addEventListener('click', ()=>{audio.play();btn.classList.add('playing')}, {once:true}); }); };
            play();
            audio.onended = () => { idx = (idx+1)%state.music.length; play(); };
            btn.onclick = () => { if(audio.paused) { audio.play(); btn.classList.add('playing'); } else { audio.pause(); btn.classList.remove('playing'); } };
        }

        // --- 核心修复：显式挂载函数到 Window ---
        window.openAdmin = () => { $('admin-modal').style.display = 'flex'; if(state.loggedIn) loadAdminPanel(); };
        window.closeModal = () => $('admin-modal').style.display = 'none';
        window.login = () => {
            if($('admin-pwd').value === ADMIN_PASS) {
                state.loggedIn = true; $('login-section').classList.add('hidden'); $('admin-panel').classList.remove('hidden');
                loadAdminPanel(); renderMain();
            } else alert('密码错误');
        };

        window.saveSettings = async () => {
            const bgs = $('set-bg').value.split('\n').filter(t=>t.trim());
            const data = { siteIconUrl: $('set-icon').value, welcomeMessage: $('set-welcome').value, backgroundUrls: JSON.stringify(bgs) };
            if((await api.post('settings', data)).ok) { alert('已保存'); location.reload(); }
        };

        window.addCategory = async () => {
            if((await api.post('categories', {name: $('cat-name').value, is_private: $('cat-private').checked})).ok) reloadData();
        };
        window.addSite = async () => {
            const data = { categoryId: $('site-cat').value, name: $('site-name').value, url: $('site-url').value, icon: $('site-icon').value || `https://www.google.com/s2/favicons?domain=${new URL($('site-url').value).hostname}&sz=64` };
            if((await api.post('sites', data)).ok) reloadData();
        };
        window.addMusic = async () => {
            if((await api.post('custom-music', {title: $('music-name').value, url: $('music-url').value})).ok) reloadData();
        };
        window.delItem = async (type, id) => { if(confirm('删除？') && (await api.del(`${type}/${id}`)).ok) reloadData(); };

        $('site-url').onblur = function() { if(this.value && !$('site-icon').value) try { $('site-icon').value = `https://www.google.com/s2/favicons?domain=${new URL(this.value).hostname}&sz=64`; } catch{} };
        $('search-input').oninput = function() {
            const term = this.value.toLowerCase();
            document.querySelectorAll('.site-item').forEach(el => el.parentElement.style.display = el.innerText.toLowerCase().includes(term) ? 'block' : 'none');
        };

        async function reloadData() {
            const [c, s, m] = await Promise.all([api.get('categories'), api.get('sites'), api.get('custom-music')]);
            state.cats = c; state.sites = s; state.music = m;
            loadAdminPanel(); renderMain();
        }

        async function loadAdminPanel() {
            $('set-icon').value = state.settings.siteIconUrl || '';
            $('set-welcome').value = state.settings.welcomeMessage || '';
            try { $('set-bg').value = JSON.parse(state.settings.backgroundUrls).join('\n'); } catch { $('set-bg').value = state.settings.backgroundUrls||''; }
            $('music-list').innerHTML = state.music.map(m => `<div class="flex justify-between bg-black/20 p-2 rounded mb-1 border border-white/5"><span class="truncate w-40 text-xs">${m.title}</span><button onclick="delItem('custom-music', ${m.id})" class="text-red-400"><i class="fas fa-trash"></i></button></div>`).join('');
            $('site-cat').innerHTML = state.cats.map(c => `<option value="${c.id}">${c.name}${c.is_private?' (私)':''}</option>`).join('');
            $('admin-site-list').innerHTML = state.sites.map(s => `<div class="flex justify-between bg-black/20 p-2 rounded mb-1 border border-white/5"><span class="truncate w-40 text-xs">${s.name}</span><button onclick="delItem('sites', ${s.id})" class="text-red-400"><i class="fas fa-trash"></i></button></div>`).join('');
            if (state.settings.siteIconUrl) {
                // 同时更新浏览器favicon
                let link = document.querySelector("link[rel~='icon']");
                if (!link) { link = document.createElement('link'); link.rel = 'icon'; document.head.appendChild(link); }
                link.href = state.settings.siteIconUrl;
            }
        }
        
        function renderVisitorList(list) {
            $('visitor-list').innerHTML = list.map(v => `<div class="flex justify-between border-b border-white/5 pb-1"><span>${v.ip_address}</span><span>${new Date(v.visit_time).toLocaleTimeString()}</span></div>`).join('');
        }

        init();
    </script>
</body>
</html>
