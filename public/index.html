<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å¯¼èˆªç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --glass: rgba(20, 20, 20, 0.6); --border: rgba(255, 255, 255, 0.1); }
        body { margin: 0; font-family: sans-serif; background: #0f172a; color: white; min-height: 100vh; overflow-x: hidden; }
        
        /* å¹»ç¯ç‰‡èƒŒæ™¯ */
        #bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; }
        .bg-slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 1.5s; }
        .bg-slide.active { opacity: 1; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: -1; }

        /* é¡¶éƒ¨ç£¨ç ‚æ  */
        .top-bar { position: fixed; top: 0; width: 100%; height: 64px; background: var(--glass); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; z-index: 50; }
        .marquee { flex: 1; margin: 0 2rem; overflow: hidden; white-space: nowrap; color: #ccc; font-size: 0.9rem; mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); }
        .marquee span { display: inline-block; animation: scroll 20s linear infinite; }
        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* ä¸»å†…å®¹åŒº */
        .container { max-width: 1200px; margin: 100px auto 50px; padding: 0 20px; }
        
        /* æŠ˜å åˆ†ç±» */
        .cat-box { margin-bottom: 40px; }
        .cat-header { display: inline-flex; align-items: center; gap: 10px; padding: 8px 20px; background: rgba(255,255,255,0.05); border-radius: 30px; cursor: pointer; border: 1px solid transparent; transition: 0.3s; }
        .cat-header:hover { background: rgba(255,255,255,0.15); border-color: var(--border); }
        .cat-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 25px; padding: 25px 10px; transition: 0.5s; overflow: hidden; max-height: 2000px; }
        .cat-content.collapsed { max-height: 0; padding: 0; opacity: 0; }

        /* åœ†å½¢ç»ç’ƒå›¾æ ‡ */
        .site { display: flex; flex-direction: column; align-items: center; gap: 10px; text-decoration: none; color: white; }
        .icon-box { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .site:hover .icon-box { transform: scale(1.1); background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.5); }
        .site-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .site-name { font-size: 0.8rem; opacity: 0.8; width: 120%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        /* é¡¶éƒ¨æŒ‰é’® */
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.3s; }
        .btn-icon:hover { background: white; color: black; }
        .btn-icon.playing { animation: pulse 2s infinite; background: #10b981; border-color: transparent; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } }

        /* æ¨¡æ€æ¡† */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-box { background: #1e293b; width: 95%; max-width: 900px; max-height: 85vh; border-radius: 16px; border: 1px solid #334155; display: flex; flex-direction: column; }
        .modal-head { padding: 15px 20px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; font-weight: bold; background: #0f172a; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }

        input, textarea, select { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; width: 100%; outline: none; font-size: 14px; }
        input:focus { border-color: #6366f1; background: rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="bg-container"></div>
    <div class="overlay"></div>

    <div class="top-bar">
        <div class="flex items-center gap-3">
            <img id="logo-img" class="w-8 h-8 rounded-full border border-white/20 hidden">
            <span class="font-bold tracking-widest text-sm">PORTAL</span>
        </div>
        <div class="marquee">
            <span id="welcome-text">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</span>
        </div>
        <div class="flex items-center gap-3">
            <div class="relative">
                <input id="search-input" placeholder="æœç´¢..." class="rounded-full px-4 py-1 text-xs w-24 focus:w-40 transition" style="background:rgba(255,255,255,0.1)">
            </div>
            <button id="music-btn" class="btn-icon" onclick="toggleMusic()" title="æ’­æ”¾/æš‚åœ"><i class="fas fa-music text-xs"></i></button>
            <button class="btn-icon" onclick="openAdmin()" title="ç§å¯†ç©ºé—´"><i class="fas fa-shield-alt text-xs"></i></button>
        </div>
    </div>

    <div id="main-content" class="container"></div>

    <div id="admin-modal" class="modal">
        <div class="modal-box">
            <div class="modal-head">
                <span><i class="fas fa-cogs text-blue-400 mr-2"></i> ç®¡ç†åå° & ç§å¯†ç©ºé—´</span>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body space-y-8">
                
                <div id="login-view" class="text-center py-12">
                    <div class="text-4xl mb-4">ğŸ”’</div>
                    <h3 class="text-xl font-bold mb-6">èº«ä»½éªŒè¯</h3>
                    <input type="password" id="pwd" placeholder="è¯·è¾“å…¥å¯†ç  (é»˜è®¤ Qq110110.)" class="w-64 mb-4 text-center mx-auto block">
                    <button onclick="doLogin()" class="bg-indigo-600 hover:bg-indigo-500 px-8 py-2 rounded font-bold transition">è§£é”</button>
                </div>

                <div id="panel-view" class="hidden space-y-6">
                    <div class="grid grid-cols-2 gap-4 text-center bg-black/20 p-4 rounded-xl border border-white/5">
                        <div><div class="text-xs text-gray-400">æ€»è®¿é—®</div><div id="stat-total" class="text-2xl font-bold">0</div></div>
                        <div><div class="text-xs text-gray-400">ä»Šæ—¥</div><div id="stat-today" class="text-2xl font-bold text-green-400">0</div></div>
                    </div>
                    <div class="bg-black/20 p-4 rounded-xl border border-white/5">
                        <div class="text-xs text-gray-400 mb-2 font-bold uppercase">æœ€è¿‘è®¿å®¢ IP</div>
                        <div id="visitor-list" class="text-xs text-gray-400 space-y-1 font-mono max-h-24 overflow-y-auto"></div>
                    </div>

                    <div class="bg-white/5 p-5 rounded-xl border border-white/10 space-y-3">
                        <h3 class="text-sm font-bold text-blue-400 uppercase">å…¨å±€è®¾ç½®</h3>
                        <input id="set-icon" placeholder="ç½‘ç«™å¤´åƒ URL (å¦‚ favicon.ico)">
                        <input id="set-welcome" placeholder="é¡¶éƒ¨æ»šåŠ¨è¯´æ˜è¯­">
                        <textarea id="set-bg" rows="3" placeholder="èƒŒæ™¯å›¾URL (æ¯è¡Œä¸€å¼ ï¼Œè‡ªåŠ¨è½®æ’­)"></textarea>
                        <button onclick="saveSettings()" class="bg-blue-600 w-full py-2 rounded font-bold text-sm hover:bg-blue-500">ä¿å­˜è®¾ç½®</button>
                    </div>

                    <div class="bg-white/5 p-5 rounded-xl border border-white/10">
                        <h3 class="text-sm font-bold text-green-400 uppercase mb-3">èƒŒæ™¯éŸ³ä¹</h3>
                        <div class="flex gap-2 mb-3">
                            <input id="music-name" placeholder="æ­Œå" class="flex-1">
                            <input id="music-url" placeholder="MP3é“¾æ¥" class="flex-1">
                            <button onclick="addMusic()" class="bg-green-600 px-4 rounded hover:bg-green-500 text-sm font-bold">æ·»åŠ </button>
                        </div>
                        <div id="music-list" class="space-y-1 max-h-40 overflow-y-auto"></div>
                    </div>

                    <div class="bg-white/5 p-5 rounded-xl border border-white/10">
                        <h3 class="text-sm font-bold text-purple-400 uppercase mb-3">å†…å®¹ç®¡ç†</h3>
                        <div class="flex gap-2 mb-4 bg-black/20 p-2 rounded">
                            <input id="cat-name" placeholder="æ–°åˆ†ç±»åç§°" class="bg-transparent border-none">
                            <label class="flex items-center gap-1 text-xs text-yellow-500 whitespace-nowrap cursor-pointer"><input type="checkbox" id="cat-private"> ç§å¯†</label>
                            <button onclick="addCat()" class="bg-gray-700 px-3 rounded text-xs hover:bg-gray-600">åŠ åˆ†ç±»</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <select id="site-cat"></select>
                            <input id="site-name" placeholder="ç½‘ç«™åç§°">
                            <input id="site-url" class="col-span-2" placeholder="ç½‘å€ (ç§»å¼€è‡ªåŠ¨æŠ“å–å›¾æ ‡)" onblur="autoIcon(this)">
                            <input id="site-icon" class="col-span-2" placeholder="å›¾æ ‡URL (å¯é€‰)">
                        </div>
                        <button onclick="addSite()" class="w-full bg-indigo-600 py-2 rounded font-bold text-sm hover:bg-indigo-500">æ·»åŠ ç½‘ç«™</button>
                        <div id="site-list" class="mt-4 space-y-1 max-h-60 overflow-y-auto"></div>
                    </div>
                    
                    <div class="text-center pt-2">
                        <button onclick="location.reload()" class="text-red-400 text-xs hover:underline">é€€å‡ºç™»å½•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="audio" loop></audio>

    <script>
        const API = '/api';
        const PWD = 'Qq110110.';
        let state = { logged: false, bgIdx: 0 };
        const $ = (id) => document.getElementById(id);
        
        const req = async (ep, method='GET', data) => {
            try {
                const opts = { method, headers: {'Content-Type': 'application/json'} };
                if(data) opts.body = JSON.stringify(data);
                const res = await fetch(API + ep, opts);
                return res.ok ? await res.json() : null;
            } catch { return null; }
        };

        // --- åˆå§‹åŒ– ---
        async function init() {
            const [s, c, si, m, v] = await Promise.all([
                req('/settings'), req('/categories'), req('/sites'), req('/custom-music'), req('/visitor')
            ]);
            
            // èƒŒæ™¯å¹»ç¯ç‰‡
            let bgs = [];
            try { bgs = JSON.parse(s.backgroundUrls); } catch { bgs = [s.backgroundUrls]; }
            bgs = bgs.filter(x=>x);
            if(!bgs.length) bgs=['https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=1920'];
            
            $('bg-container').innerHTML = bgs.map((u,i) => `<div class="bg-slide ${i==0?'active':''}" style="background-image:url('${u}')"></div>`).join('');
            if(bgs.length > 1) setInterval(() => {
                const slides = document.querySelectorAll('.bg-slide');
                slides[state.bgIdx].classList.remove('active');
                state.bgIdx = (state.bgIdx+1) % slides.length;
                slides[state.bgIdx].classList.add('active');
            }, 8000);

            // åº”ç”¨è®¾ç½®
            if(s.siteIconUrl) { $('logo-img').src = s.siteIconUrl; $('logo-img').classList.remove('hidden'); }
            if(s.welcomeMessage) $('welcome-text').innerText = s.welcomeMessage;
            
            // æ¸²æŸ“ä¸»é¡µ
            renderMain(c || [], si || []);
            
            // éŸ³ä¹ (å¼ºåŠ›è‡ªåŠ¨æ’­æ”¾)
            if(m && m.length) {
                const a = $('audio');
                let idx = 0;
                const play = () => { 
                    a.src = m[idx].url; 
                    a.play().then(()=>$('music-btn').classList.add('playing')).catch(()=>{
                        document.addEventListener('click', ()=>{a.play();$('music-btn').classList.add('playing')}, {once:true});
                    }); 
                };
                play();
                a.onended = () => { idx = (idx+1)%m.length; play(); };
                $('music-btn').onclick = () => { if(a.paused){a.play();$('music-btn').classList.add('playing')}else{a.pause();$('music-btn').classList.remove('playing')} };
            }

            // ç»Ÿè®¡
            if(v) { 
                $('stat-total').innerText = v.total; 
                $('stat-today').innerText = v.today; 
                if(v.recent) $('visitor-list').innerHTML = v.recent.map(r=>`<div class="flex justify-between border-b border-white/5 pb-1"><span>${r.ip_address}</span><span>${new Date(r.visit_time).toLocaleTimeString()}</span></div>`).join('');
            }
            req('/visitor', 'POST', {});

            state.data = { s, c, si, m };
        }

        function renderMain(c, si) {
            const box = $('main-content'); box.innerHTML = '';
            c.forEach(cat => {
                if(!state.logged && cat.is_private) return;
                const items = si.filter(s => s.categoryId == cat.id);
                const div = document.createElement('div');
                div.className = 'cat-box fade-in';
                div.innerHTML = `
                    <div class="cat-header" onclick="this.nextElementSibling.classList.toggle('collapsed')">
                        <i class="fas fa-folder text-blue-400 mr-2"></i> ${cat.name}
                        ${cat.is_private ? '<i class="fas fa-lock text-yellow-500 text-xs ml-2"></i>' : ''}
                    </div>
                    <div class="cat-content">
                        ${items.map(s => `
                            <a href="${s.url}" target="_blank" class="site group">
                                <div class="icon-box"><img src="${s.icon}" class="site-img" onerror="this.src='https://placehold.co/50'"></div>
                                <div class="site-name group-hover:text-blue-400">${s.name}</div>
                            </a>
                        `).join('')}
                    </div>`;
                box.appendChild(div);
            });
        }

        // --- å¼ºåˆ¶æŒ‚è½½åˆ° window çš„å‡½æ•° (è§£å†³ç‚¹å‡»æ— æ•ˆ) ---
        window.openAdmin = () => { $('admin-modal').style.display = 'flex'; if(state.logged) loadPanel(); };
        window.closeModal = () => $('admin-modal').style.display = 'none';
        
        window.doLogin = () => {
            if($('pwd').value === PWD) {
                state.logged = true; $('login-view').classList.add('hidden'); $('panel-view').classList.remove('hidden');
                loadPanel(); renderMain(state.data.c, state.data.si);
            } else alert('å¯†ç é”™è¯¯');
        };

        window.loadPanel = () => {
            const { s, c, si, m } = state.data;
            $('set-icon').value = s.siteIconUrl||''; 
            $('set-welcome').value = s.welcomeMessage||'';
            try { $('set-bg').value = JSON.parse(s.backgroundUrls).join('\n'); } catch { $('set-bg').value = s.backgroundUrls||''; }
            
            $('music-list').innerHTML = m.map(x => `<div class="flex justify-between bg-white/5 p-2 rounded text-xs mb-1 border border-white/5"><span class="truncate w-40">${x.title}</span><button onclick="del('custom-music',${x.id})" class="text-red-400">åˆ </button></div>`).join('');
            $('site-cat').innerHTML = c.map(x => `<option value="${x.id}">${x.name}${x.is_private?' (ç§)':''}</option>`).join('');
            $('site-list').innerHTML = si.map(x => `<div class="flex justify-between bg-white/5 p-2 rounded text-xs mb-1 border border-white/5"><span class="truncate w-40">${x.name}</span><button onclick="del('sites',${x.id})" class="text-red-400">åˆ </button></div>`).join('');
        };

        window.saveSettings = async () => {
            const bgs = $('set-bg').value.split('\n').filter(x=>x.trim());
            const data = { siteIconUrl: $('set-icon').value, welcomeMessage: $('set-welcome').value, backgroundUrls: JSON.stringify(bgs) };
            if(await req('/settings', 'POST', data)) { alert('å·²ä¿å­˜'); location.reload(); }
        };

        window.addCat = async () => {
            if(await req('/categories', 'POST', { name: $('cat-name').value, is_private: $('cat-private').checked })) reload();
        };

        window.addSite = async () => {
            const data = {
                categoryId: $('site-cat').value,
                name: $('site-name').value,
                url: $('site-url').value,
                icon: $('site-icon').value || `https://www.google.com/s2/favicons?domain=${new URL($('site-url').value).hostname}&sz=64`
            };
            if(await req('/sites', 'POST', data)) reload();
        };

        window.addMusic = async () => {
            if(await req('/custom-music', 'POST', { title: $('music-name').value, url: $('music-url').value })) reload();
        };

        window.del = async (t, id) => {
            if(confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ') && await req(`/${t}/${id}`, 'DELETE')) reload();
        };

        window.autoIcon = (el) => {
            if(el.value && !$('site-icon').value) try { $('site-icon').value = `https://www.google.com/s2/favicons?domain=${new URL(el.value).hostname}&sz=64`; } catch{}
        };

        window.toggleMusic = () => {
            const a = $('audio');
            if(a.paused) { a.play(); $('music-btn').classList.add('playing'); } else { a.pause(); $('music-btn').classList.remove('playing'); }
        };

        async function reload() {
            const [c, si, m] = await Promise.all([req('/categories'), req('/sites'), req('/custom-music')]);
            state.data.c = c; state.data.si = si; state.data.m = m;
            loadPanel(); renderMain(c, si);
        }

        // æœç´¢
        $('search-input').oninput = function() {
            const term = this.value.toLowerCase();
            document.querySelectorAll('.site').forEach(el => el.style.display = el.innerText.toLowerCase().includes(term) ? 'flex' : 'none');
        };

        init();
    </script>
</body>
</html>
