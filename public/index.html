<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>老幺导航</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /* 基础样式 */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; 
            color: white; 
            transition: background-image 0.5s ease-in-out;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        /* 玻璃拟态 */
        .glass { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-card:hover { background: rgba(31, 41, 55, 0.8); border-color: rgba(255,255,255,0.2); }

        /* 跑马灯样式 */
        .marquee-wrapper {
            background: rgba(59, 130, 246, 0.1);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            overflow: hidden;
            white-space: nowrap;
            height: 30px;
            display: flex;
            align-items: center;
            position: relative;
        }
        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 20s linear infinite;
            font-size: 0.875rem;
            color: #93c5fd;
        }
        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }

        /* 模态框 */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; align-items: center; justify-content: center; }
        .modal.active { display: flex; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 表格样式 */
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .log-table th { text-align: left; padding: 10px; background: rgba(255,255,255,0.05); color: #9ca3af; }
        .log-table td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-table tr:hover { background: rgba(255,255,255,0.02); }

        /* 隐藏滚动条但保留功能 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- 1. 顶部 Header (搜索居中) -->
    <header class="glass h-16 flex items-center justify-between px-4 md:px-8 z-30 relative shrink-0">
        <!-- 左侧：Logo & 移动端菜单 -->
        <div class="flex items-center gap-4 z-10 w-1/4">
            <button id="mobile-menu-toggle" class="md:hidden p-2 rounded hover:bg-gray-700"><i data-lucide="menu"></i></button>
            <div class="flex items-center gap-2">
                <img id="site-logo" src="https://placehold.co/32x32/3b82f6/white?text=Nav" class="w-8 h-8 rounded-lg object-cover hidden">
                <h1 id="site-title" class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 truncate">老幺导航</h1>
            </div>
        </div>

        <!-- 中间：搜索栏 (绝对居中) -->
        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md px-4 pointer-events-none md:pointer-events-auto">
            <div class="relative group pointer-events-auto">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="search" class="w-4 h-4 text-gray-400 group-focus-within:text-blue-400 transition-colors"></i>
                </div>
                <input type="text" id="search-input" placeholder="搜索网站..." 
                    class="block w-full pl-10 pr-4 py-2 bg-gray-800/80 border border-gray-700 rounded-full text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all shadow-lg backdrop-blur-sm">
            </div>
        </div>

        <!-- 右侧：工具栏 -->
        <div class="flex items-center justify-end gap-2 z-10 w-1/4">
            <button onclick="openAdmin()" class="p-2 rounded-full hover:bg-white/10 transition text-gray-300 hover:text-white" title="管理面板">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- 2. 跑马灯公告 -->
    <div id="marquee-wrapper" class="marquee-wrapper hidden">
        <div id="marquee-text" class="marquee-content"></div>
    </div>

    <!-- 3. 主体布局 -->
    <div class="flex flex-1 overflow-hidden relative">
        <!-- 侧边栏 -->
        <aside id="sidebar" class="w-64 bg-gray-900/50 backdrop-blur border-r border-gray-800 hidden md:flex flex-col flex-shrink-0 transition-all duration-300">
            <div class="p-4 overflow-y-auto flex-1">
                <nav id="sidebar-nav" class="space-y-1"></nav>
            </div>
        </aside>

        <!-- 移动端侧边栏遮罩 -->
        <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleMobileSidebar()"></div>
        <div id="mobile-sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-900 shadow-2xl transform -translate-x-full transition-transform z-50 flex flex-col p-4">
            <div class="flex justify-end mb-4"><button onclick="toggleMobileSidebar()"><i data-lucide="x"></i></button></div>
            <nav id="mobile-nav-content" class="space-y-2"></nav>
        </div>

        <!-- 内容区域 -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative" id="main-content">
            <!-- 顶部快捷栏 -->
            <div id="topbar-nav" class="flex flex-wrap gap-2 mb-8 justify-center md:justify-start"></div>
            
            <!-- 常用网站 -->
            <div id="frequent-section" class="mb-10 hidden">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-blue-400">
                    <i data-lucide="star" class="w-5 h-5"></i> 常用推荐
                </h2>
                <div id="frequent-grid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4"></div>
            </div>

            <!-- 网站列表 -->
            <div id="sites-container" class="space-y-10 pb-20"></div>
        </main>
    </div>

    <!-- 4. 管理面板 -->
    <div id="admin-modal" class="modal">
        <!-- 登录界面 -->
        <div id="admin-login" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700">
            <h2 class="text-2xl font-bold mb-6 text-center">管理员登录</h2>
            <input type="password" id="admin-pwd" placeholder="请输入密码" class="w-full bg-gray-700 border border-gray-600 rounded p-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold transition">解锁</button>
        </div>

        <!-- 管理界面 -->
        <div id="admin-panel" class="hidden bg-gray-900 border border-gray-700 w-full max-w-6xl h-[90vh] rounded-xl flex flex-col shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-800 bg-gray-800">
                <h2 class="font-bold text-lg flex items-center gap-2"><i data-lucide="layout-dashboard"></i> 控制台</h2>
                <button onclick="closeAdmin()" class="hover:text-red-400"><i data-lucide="x"></i></button>
            </div>
            
            <div class="flex flex-1 overflow-hidden">
                <!-- 侧边 -->
                <div class="w-48 bg-gray-900 border-r border-gray-800 p-2 space-y-1">
                    <button onclick="showTab('sites')" class="admin-tab w-full text-left px-4 py-3 rounded hover:bg-gray-800 active-tab bg-gray-800 text-blue-400">网站管理</button>
                    <button onclick="showTab('cats')" class="admin-tab w-full text-left px-4 py-3 rounded hover:bg-gray-800">分类管理</button>
                    <button onclick="showTab('settings')" class="admin-tab w-full text-left px-4 py-3 rounded hover:bg-gray-800">全局设置</button>
                    <button onclick="showTab('logs')" class="admin-tab w-full text-left px-4 py-3 rounded hover:bg-gray-800">访问日志</button>
                </div>

                <!-- 内容 -->
                <div class="flex-1 p-6 overflow-y-auto bg-gray-900/50">
                    
                    <!-- Tab: 网站管理 -->
                    <div id="tab-sites" class="tab-content">
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mb-6">
                            <h3 class="font-bold mb-4 text-blue-400">添加 / 编辑网站</h3>
                            <form id="site-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="hidden" id="site-id">
                                <select id="site-cat" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm" required></select>
                                <input type="text" id="site-name" placeholder="网站名称" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm" required>
                                <input type="url" id="site-url" placeholder="链接 (https://...)" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm md:col-span-2" required>
                                
                                <div class="md:col-span-4 flex gap-2">
                                    <input type="text" id="site-icon" placeholder="图标链接 (留空自动获取)" class="flex-1 bg-gray-900 border border-gray-600 rounded p-2 text-sm">
                                    <img id="icon-preview" src="" class="w-9 h-9 bg-gray-700 rounded object-contain border border-gray-600">
                                </div>
                                <input type="text" id="site-desc" placeholder="网站说明语 / 简介" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm md:col-span-4">
                                
                                <div class="md:col-span-4 flex justify-end gap-2 mt-2">
                                    <button type="button" onclick="resetForm()" class="px-4 py-2 text-sm text-gray-400">重置</button>
                                    <button type="submit" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded text-sm font-bold">保存网站</button>
                                </div>
                            </form>
                        </div>
                        <div id="admin-site-list" class="space-y-2"></div>
                    </div>

                    <!-- Tab: 分类管理 -->
                    <div id="tab-cats" class="tab-content hidden">
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mb-6 flex gap-3">
                            <input type="text" id="cat-name" placeholder="分类名称" class="flex-1 bg-gray-900 border border-gray-600 rounded p-2">
                            <select id="cat-type" class="bg-gray-900 border border-gray-600 rounded p-2">
                                <option value="sidebar">侧边栏</option>
                                <option value="topbar">顶部栏</option>
                            </select>
                            <button onclick="addCat()" class="bg-green-600 px-6 rounded font-bold">添加</button>
                        </div>
                        <div id="admin-cat-list" class="space-y-2"></div>
                    </div>

                    <!-- Tab: 全局设置 -->
                    <div id="tab-settings" class="tab-content hidden">
                        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-6">
                            <div>
                                <label class="block text-sm font-bold mb-2 text-blue-400">站点公告 (顶部跑马灯)</label>
                                <input type="text" id="set-marquee" placeholder="输入公告内容..." class="w-full bg-gray-900 border border-gray-600 rounded p-3">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2 text-blue-400">网站 Logo URL</label>
                                <div class="flex gap-4 items-center">
                                    <input type="text" id="set-logo" placeholder="https://..." class="flex-1 bg-gray-900 border border-gray-600 rounded p-3">
                                    <img id="set-logo-preview" src="" class="w-10 h-10 rounded bg-gray-700 object-cover">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2 text-blue-400">背景图片 (一行一个 URL)</label>
                                <textarea id="set-bg" rows="5" class="w-full bg-gray-900 border border-gray-600 rounded p-3 font-mono text-sm" placeholder="https://..."></textarea>
                            </div>
                            <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-500 px-8 py-3 rounded font-bold w-full md:w-auto">保存设置</button>
                        </div>
                    </div>

                    <!-- Tab: 访问日志 -->
                    <div id="tab-logs" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold">最新访问记录</h3>
                            <button onclick="loadLogs()" class="text-xs text-blue-400 hover:text-blue-300">刷新</button>
                        </div>
                        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                            <table class="log-table">
                                <thead><tr><th class="w-40">时间</th><th class="w-40">IP 地址</th><th>访问内容</th></tr></thead>
                                <tbody id="logs-body"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PWD = "110110";
        
        // --- MockDB (内存数据库) ---
        const MockDB = {
            data: {
                settings: {
                    announcement: "欢迎访问老幺导航！这里是预览模式。",
                    siteLogo: "https://placehold.co/32x32/3b82f6/white?text=Nav",
                    background_config: JSON.stringify([])
                },
                categories: [
                    { id: 1, name: '常用推荐', type: 'sidebar', displayOrder: 1 },
                    { id: 2, name: '设计工具', type: 'topbar', displayOrder: 2 }
                ],
                sites: [
                    { id: 1, categoryId: 1, name: 'Google', url: 'https://google.com', icon: 'https://www.google.com/favicon.ico', description: '搜索引擎', visit_count: 100 },
                    { id: 2, categoryId: 1, name: 'Bilibili', url: 'https://bilibili.com', icon: 'https://www.bilibili.com/favicon.ico', description: '干杯', visit_count: 88 }
                ],
                logs: [
                    { id: 1, ip_address: "127.0.0.1 (Mock)", created_at: new Date().toISOString(), site_name: "Google" }
                ]
            },
            
            async handle(endpoint, method, body) {
                console.log(`[MockDB] ${method} ${endpoint}`, body);
                await new Promise(r => setTimeout(r, 50)); 

                if (endpoint === 'settings') {
                    if (method === 'POST') { Object.assign(this.data.settings, body); return { success: true }; }
                    return this.data.settings;
                }
                if (endpoint === 'categories') {
                    if (method === 'POST') {
                        this.data.categories.push({ id: Date.now(), ...body, displayOrder: this.data.categories.length });
                        return { success: true };
                    }
                    if (method === 'DELETE') {
                        const id = parseInt(endpoint.split('/')[1]); 
                        this.data.categories = this.data.categories.filter(c => c.id !== id);
                        return { success: true };
                    }
                    return this.data.categories;
                }
                if (endpoint.startsWith('sites')) {
                    if (method === 'POST') {
                        this.data.sites.push({ id: Date.now(), ...body, visit_count: 0 });
                        return { success: true };
                    }
                    if (method === 'PUT') {
                        const id = parseInt(endpoint.split('/')[1]);
                        const idx = this.data.sites.findIndex(s => s.id === id);
                        if (idx !== -1) this.data.sites[idx] = { ...this.data.sites[idx], ...body };
                        return { success: true };
                    }
                    if (method === 'DELETE') {
                        const id = parseInt(endpoint.split('/')[1]);
                        this.data.sites = this.data.sites.filter(s => s.id !== id);
                        return { success: true };
                    }
                    return this.data.sites;
                }
                if (endpoint === 'logs') return this.data.logs;
                if (endpoint.startsWith('visit')) return { success: true };
                
                return [];
            }
        };

        // --- API 客户端 (彻底的防白屏机制) ---
        const api = {
            async request(endpoint, method = 'GET', data = null) {
                // 1. 强制检查：是否为Blob预览环境
                const isBlob = window.location.protocol === 'blob:' || window.location.href.startsWith('blob:');
                if (isBlob) {
                    return MockDB.handle(endpoint, method, data);
                }

                // 2. 尝试真实请求，但如果失败，绝对不抛出错误，而是降级到Mock
                try {
                    const opts = { method, headers: { 'Content-Type': 'application/json' } };
                    if (data) opts.body = JSON.stringify(data);
                    
                    const res = await fetch(`/api/${endpoint}`, opts);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (e) {
                    console.warn(`[Auto Fallback] API Failed (${endpoint}). Using Mock Data.`);
                    return MockDB.handle(endpoint, method, data);
                }
            },
            
            get: (url) => api.request(url, 'GET'),
            post: (url, data) => api.request(url, 'POST', data),
            put: (url, data) => api.request(url, 'PUT', data),
            del: (url) => api.request(url, 'DELETE')
        };

        // --- 页面逻辑 ---
        const state = { sites: [], cats: [], settings: {}, backgrounds: [], bgIndex: 0 };

        async function init() {
            try {
                // 并行加载，即使某个失败也会被 API Client 捕获并返回 Mock
                const [sites, cats, sets] = await Promise.all([
                    api.get('sites'), api.get('categories'), api.get('settings')
                ]);
                state.sites = sites || [];
                state.cats = cats || [];
                state.settings = sets || {};
                
                // 背景处理
                try {
                    if (sets.background_config) {
                        state.backgrounds = JSON.parse(sets.background_config);
                    } else if (sets.backgroundUrl) {
                        state.backgrounds = [sets.backgroundUrl];
                    }
                } catch (e) { state.backgrounds = []; }
                
                renderApp();
                startSlideshow();
            } catch (e) { console.error("Init failed", e); }
        }

        function renderApp() {
            // Logo
            if (state.settings.siteLogo) {
                document.getElementById('site-logo').src = state.settings.siteLogo;
                document.getElementById('site-logo').classList.remove('hidden');
            }
            // 背景
            if (state.settings.backgroundUrl) {
                document.body.style.backgroundImage = `url('${state.settings.backgroundUrl}')`;
            }
            // 跑马灯
            const marquee = state.settings.announcement;
            const el = document.getElementById('marquee-wrapper');
            if (marquee) {
                document.getElementById('marquee-text').textContent = marquee;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }

            // 导航栏
            const sidebar = document.getElementById('sidebar-nav');
            const topbar = document.getElementById('topbar-nav');
            const mobile = document.getElementById('mobile-nav-content');
            sidebar.innerHTML = ''; topbar.innerHTML = ''; mobile.innerHTML = '';

            state.cats.sort((a,b) => (a.displayOrder||0) - (b.displayOrder||0)).forEach(cat => {
                const btn = document.createElement('a');
                btn.className = "block px-4 py-2 rounded text-gray-300 hover:bg-white/10 hover:text-white transition cursor-pointer text-sm font-medium";
                btn.innerHTML = `<span class="flex items-center gap-2"><i data-lucide="folder" class="w-4 h-4"></i> ${cat.name}</span>`;
                btn.onclick = () => document.getElementById(`cat-${cat.id}`)?.scrollIntoView({behavior: 'smooth'});

                if (cat.type === 'sidebar') {
                    sidebar.appendChild(btn);
                    mobile.appendChild(btn.cloneNode(true));
                } else {
                    const topBtn = btn.cloneNode(true);
                    topBtn.className = "px-4 py-1.5 bg-gray-800 hover:bg-gray-700 rounded-full text-xs border border-gray-700 transition cursor-pointer";
                    topbar.appendChild(topBtn);
                }
            });

            // 网站列表
            const container = document.getElementById('sites-container');
            container.innerHTML = '';
            
            state.cats.forEach(cat => {
                const sites = state.sites.filter(s => s.categoryId == cat.id).sort((a,b) => (a.display_order||0) - (b.display_order||0));
                if (sites.length === 0) return;

                const section = document.createElement('div');
                section.id = `cat-${cat.id}`;
                section.innerHTML = `<h3 class="text-xl font-bold mb-5 pl-2 border-l-4 border-blue-500 text-gray-100">${cat.name}</h3>`;
                
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4";
                
                sites.forEach(site => {
                    const card = document.createElement('a');
                    card.href = site.url;
                    card.target = "_blank";
                    card.className = "glass-card p-4 rounded-xl flex items-center gap-4 transition-all duration-300 hover:-translate-y-1 group";
                    card.onclick = () => api.post(`visit/${site.id}`);

                    const icon = site.icon || `https://www.google.com/s2/favicons?domain=${site.url}&sz=64`;
                    
                    card.innerHTML = `
                        <img src="${icon}" class="w-10 h-10 rounded-lg bg-gray-900 object-contain shadow-sm group-hover:scale-110 transition" onerror="this.src='https://placehold.co/40?text=?'">
                        <div class="min-w-0 flex-1">
                            <h4 class="font-bold text-sm text-gray-200 truncate group-hover:text-blue-400 transition">${site.name}</h4>
                            <p class="text-xs text-gray-500 truncate mt-0.5">${site.description || '暂无简介'}</p>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                section.appendChild(grid);
                container.appendChild(section);
            });

            // 常用
            const freq = [...state.sites].sort((a,b) => (b.visit_count||0) - (a.visit_count||0)).slice(0, 8);
            if (freq.length > 0) {
                document.getElementById('frequent-section').classList.remove('hidden');
                document.getElementById('frequent-grid').innerHTML = freq.map(s => `
                    <a href="${s.url}" target="_blank" onclick="api.post('visit/${s.id}')" class="flex flex-col items-center p-3 rounded-lg hover:bg-white/5 transition group">
                        <img src="${s.icon || `https://www.google.com/s2/favicons?domain=${s.url}&sz=64`}" class="w-10 h-10 rounded-lg mb-2 shadow-md">
                        <span class="text-xs text-gray-400 group-hover:text-white truncate w-full text-center">${s.name}</span>
                    </a>
                `).join('');
            }
            lucide.createIcons();
        }

        // 背景轮播
        function startSlideshow() {
            if (state.bgInterval) clearInterval(state.bgInterval);
            if (!state.backgrounds || state.backgrounds.length === 0) return;
            
            const next = () => {
                const url = state.backgrounds[state.bgIndex];
                document.body.style.backgroundImage = `url('${url}')`;
                state.bgIndex = (state.bgIndex + 1) % state.backgrounds.length;
            };
            next();
            if (state.backgrounds.length > 1) state.bgInterval = setInterval(next, 5000);
        }

        // --- 管理逻辑 ---
        function openAdmin() { document.getElementById('admin-modal').classList.add('active'); }
        function closeAdmin() { document.getElementById('admin-modal').classList.remove('active'); document.getElementById('admin-login').classList.remove('hidden'); document.getElementById('admin-panel').classList.add('hidden'); }
        
        function login() {
            if (document.getElementById('admin-pwd').value === ADMIN_PWD) {
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                renderAdminUI();
            } else { alert("密码错误"); }
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active-tab', 'text-blue-400', 'bg-gray-800'));
            event.target.classList.add('active-tab', 'text-blue-400', 'bg-gray-800');
        }

        function renderAdminUI() {
            const sel = document.getElementById('site-cat');
            sel.innerHTML = state.cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            document.getElementById('admin-site-list').innerHTML = state.sites.map(s => `
                <div class="flex justify-between items-center bg-gray-800 p-3 rounded border border-gray-700">
                    <span class="text-sm font-bold truncate w-1/3">${s.name}</span>
                    <div class="flex gap-2">
                        <button onclick="editSite(${s.id})" class="text-xs text-blue-400">编辑</button>
                        <button onclick="delSite(${s.id})" class="text-xs text-red-400">删除</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('admin-cat-list').innerHTML = state.cats.map(c => `
                <div class="flex justify-between items-center bg-gray-800 p-3 rounded border border-gray-700">
                    <span class="text-sm">${c.name} <span class="text-xs bg-gray-700 px-1 rounded">${c.type}</span></span>
                    <button onclick="delCat(${c.id})" class="text-xs text-red-400">删除</button>
                </div>
            `).join('');

            document.getElementById('set-marquee').value = state.settings.announcement || '';
            document.getElementById('set-logo').value = state.settings.siteLogo || '';
            document.getElementById('set-logo-preview').src = state.settings.siteLogo || '';
            const bgs = state.backgrounds || [];
            document.getElementById('set-bg').value = bgs.join('\n');
        }

        async function saveSettings() {
            const bgText = document.getElementById('set-bg').value;
            const bgList = bgText.split('\n').map(s => s.trim()).filter(Boolean);
            const data = {
                announcement: document.getElementById('set-marquee').value,
                siteLogo: document.getElementById('set-logo').value,
                background_config: JSON.stringify(bgList)
            };
            await api.post('settings', data);
            alert("设置已保存");
            init(); 
        }

        document.getElementById('site-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('site-id').value;
            const data = {
                categoryId: parseInt(document.getElementById('site-cat').value),
                name: document.getElementById('site-name').value,
                url: document.getElementById('site-url').value,
                icon: document.getElementById('site-icon').value,
                description: document.getElementById('site-desc').value
            };
            
            if (id) await api.put(`sites/${id}`, data);
            else await api.post('sites', data);
            
            resetForm();
            init(); renderAdminUI();
        };

        async function addCat() {
            const name = document.getElementById('cat-name').value;
            const type = document.getElementById('cat-type').value;
            if(!name) return;
            await api.post('categories', {name, type});
            document.getElementById('cat-name').value = '';
            init(); renderAdminUI();
        }

        window.editSite = (id) => {
            const s = state.sites.find(x => x.id == id);
            if (!s) return;
            document.getElementById('site-id').value = s.id;
            document.getElementById('site-cat').value = s.categoryId;
            document.getElementById('site-name').value = s.name;
            document.getElementById('site-url').value = s.url;
            document.getElementById('site-icon').value = s.icon;
            document.getElementById('site-desc').value = s.description;
            document.getElementById('icon-preview').src = s.icon;
        };
        window.delSite = async (id) => { if(confirm("删除？")) { await api.del(`sites/${id}`); init(); renderAdminUI(); }};
        window.delCat = async (id) => { if(confirm("删除分类？")) { await api.del(`categories/${id}`); init(); renderAdminUI(); }};
        window.resetForm = () => { document.getElementById('site-form').reset(); document.getElementById('site-id').value = ''; document.getElementById('icon-preview').src = ''; };
        
        document.getElementById('site-url').onblur = function() {
            if(this.value && !document.getElementById('site-icon').value) {
                try {
                    const host = new URL(this.value).hostname;
                    document.getElementById('site-icon').value = `https://www.google.com/s2/favicons?domain=${host}&sz=64`;
                    document.getElementById('icon-preview').src = document.getElementById('site-icon').value;
                } catch(e){}
            }
        };
        document.getElementById('site-icon').oninput = function() { document.getElementById('icon-preview').src = this.value; };
        document.getElementById('set-logo').oninput = function() { document.getElementById('set-logo-preview').src = this.value; };

        document.getElementById('search-input').oninput = function() {
            const term = this.value.toLowerCase();
            document.querySelectorAll('.glass-card').forEach(card => {
                card.style.display = card.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
            });
        };
        
        window.loadLogs = async () => {
            const logs = await api.get('logs');
            document.getElementById('logs-body').innerHTML = logs.map(l => `
                <tr>
                    <td class="text-gray-400">${new Date(l.created_at).toLocaleString()}</td>
                    <td class="font-mono text-blue-300">${l.ip_address}</td>
                    <td>${l.site_name || '已删除'}</td>
                </tr>
            `).join('');
        };

        function toggleMobileSidebar() {
            const el = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('mobile-sidebar-overlay');
            el.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }
        document.getElementById('mobile-menu-toggle').onclick = toggleMobileSidebar;

        init();
        lucide.createIcons();
    </script>
</body>
</html>
