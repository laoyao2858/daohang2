<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>老幺导航</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; 
            color: white; 
            transition: background-image 0.5s ease-in-out;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .glass { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-card:hover { background: rgba(31, 41, 55, 0.8); border-color: rgba(255,255,255,0.2); }
        .marquee-wrapper {
            background: rgba(59, 130, 246, 0.1);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            overflow: hidden;
            white-space: nowrap;
            height: 30px;
            display: flex;
            align-items: center;
        }
        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 20s linear infinite;
            font-size: 0.875rem;
            color: #93c5fd;
        }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .log-table th { text-align: left; padding: 10px; background: rgba(255,255,255,0.05); color: #9ca3af; }
        .log-table td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- 顶部导航 -->
    <header class="glass h-16 flex items-center justify-between px-4 md:px-8 z-30 relative shrink-0">
        <div class="flex items-center gap-4 z-10 w-1/4">
            <button id="mobile-menu-toggle" class="md:hidden p-2 rounded hover:bg-gray-700"><i data-lucide="menu"></i></button>
            <div class="flex items-center gap-2">
                <img id="site-logo" src="" class="w-8 h-8 rounded-lg object-cover hidden">
                <h1 id="site-title" class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 truncate">老幺导航</h1>
            </div>
        </div>
        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md px-4 pointer-events-auto">
            <div class="relative group">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                <input type="text" id="search-input" placeholder="搜索网站..." class="block w-full pl-10 pr-4 py-2 bg-gray-800/80 border border-gray-700 rounded-full text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-lg">
            </div>
        </div>
        <div class="flex items-center justify-end gap-2 z-10 w-1/4">
            <button onclick="openAdmin()" class="p-2 rounded-full hover:bg-white/10" title="管理面板"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </div>
    </header>

    <!-- 跑马灯 -->
    <div id="marquee-wrapper" class="marquee-wrapper hidden">
        <div id="marquee-text" class="marquee-content"></div>
    </div>

    <!-- 主体 -->
    <div class="flex flex-1 overflow-hidden relative">
        <aside id="sidebar" class="w-64 bg-gray-900/50 backdrop-blur border-r border-gray-800 hidden md:flex flex-col p-4 overflow-y-auto">
            <nav id="sidebar-nav" class="space-y-1"></nav>
        </aside>
        
        <div id="mobile-sidebar" class="fixed inset-0 z-40 hidden">
            <div class="absolute inset-0 bg-black/50" onclick="toggleMobileSidebar()"></div>
            <div class="absolute left-0 top-0 h-full w-64 bg-gray-900 p-4 transform transition-transform">
                <nav id="mobile-nav-content" class="space-y-2"></nav>
            </div>
        </div>

        <main class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative">
            <div id="topbar-nav" class="flex flex-wrap gap-2 mb-8 justify-center md:justify-start"></div>
            <div id="frequent-section" class="mb-10 hidden">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-blue-400"><i data-lucide="star" class="w-5 h-5"></i> 常用推荐</h2>
                <div id="frequent-grid" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-4"></div>
            </div>
            <div id="sites-container" class="space-y-10 pb-20"></div>
        </main>
    </div>

    <!-- 管理面板 -->
    <div id="admin-modal" class="modal">
        <div id="admin-login" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700">
            <h2 class="text-2xl font-bold mb-6 text-center">管理员登录</h2>
            <input type="password" id="admin-pwd" placeholder="请输入密码" class="w-full bg-gray-700 border border-gray-600 rounded p-3 mb-4 outline-none">
            <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold">解锁</button>
        </div>

        <div id="admin-panel" class="hidden bg-gray-900 border border-gray-700 w-full max-w-6xl h-[90vh] rounded-xl flex flex-col shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-800 bg-gray-800">
                <h2 class="font-bold text-lg">控制台</h2>
                <button onclick="closeAdmin()" class="hover:text-red-400"><i data-lucide="x"></i></button>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-48 bg-gray-900 border-r border-gray-800 p-2 space-y-1">
                    <button onclick="showTab('sites')" class="admin-tab w-full text-left px-4 py-3 rounded hover:bg-gray-800 active-tab bg-gray-800 text-blue-400">网站管理</button>
                    <button onclick="showTab('cats')" class="admin-tab w-full text-left px-4 py-3 rounded hover:bg-gray-800">分类管理</button>
                    <button onclick="showTab('settings')" class="admin-tab w-full text-left px-4 py-3 rounded hover:bg-gray-800">全局设置</button>
                    <button onclick="showTab('logs')" class="admin-tab w-full text-left px-4 py-3 rounded hover:bg-gray-800">访问日志</button>
                </div>
                <div class="flex-1 p-6 overflow-y-auto bg-gray-900/50">
                    <div id="tab-sites" class="tab-content">
                        <form id="site-form" class="bg-gray-800 p-5 rounded-lg border border-gray-700 mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="hidden" id="site-id">
                            <select id="site-cat" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm" required></select>
                            <input type="text" id="site-name" placeholder="网站名称" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm" required>
                            <input type="url" id="site-url" placeholder="URL" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm md:col-span-2" required>
                            <div class="md:col-span-4 flex gap-2">
                                <input type="text" id="site-icon" placeholder="图标链接" class="flex-1 bg-gray-900 border border-gray-600 rounded p-2 text-sm">
                                <img id="icon-preview" src="" class="w-9 h-9 bg-gray-700 rounded object-contain">
                            </div>
                            <input type="text" id="site-desc" placeholder="简介" class="bg-gray-900 border border-gray-600 rounded p-2 text-sm md:col-span-4">
                            <div class="md:col-span-4 flex justify-end gap-2"><button type="button" onclick="resetForm()" class="px-4 py-2 text-sm text-gray-400">重置</button><button type="submit" class="bg-blue-600 px-6 py-2 rounded text-sm font-bold">保存</button></div>
                        </form>
                        <div id="admin-site-list" class="space-y-2"></div>
                    </div>
                    <div id="tab-cats" class="tab-content hidden">
                        <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 mb-6 flex gap-3">
                            <input type="text" id="cat-name" placeholder="分类名称" class="flex-1 bg-gray-900 border border-gray-600 rounded p-2">
                            <select id="cat-type" class="bg-gray-900 border border-gray-600 rounded p-2"><option value="sidebar">侧边栏</option><option value="topbar">顶部栏</option></select>
                            <button onclick="addCat()" class="bg-green-600 px-6 rounded font-bold">添加</button>
                        </div>
                        <div id="admin-cat-list" class="space-y-2"></div>
                    </div>
                    <div id="tab-settings" class="tab-content hidden">
                        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-6">
                            <div><label class="block text-sm font-bold mb-2 text-blue-400">公告 (跑马灯)</label><input type="text" id="set-marquee" class="w-full bg-gray-900 border border-gray-600 rounded p-3"></div>
                            <div><label class="block text-sm font-bold mb-2 text-blue-400">网站 Logo</label><div class="flex gap-4"><input type="text" id="set-logo" class="flex-1 bg-gray-900 border border-gray-600 rounded p-3"><img id="set-logo-preview" class="w-10 h-10 rounded"></div></div>
                            <div><label class="block text-sm font-bold mb-2 text-blue-400">背景图片 (一行一个)</label><textarea id="set-bg" rows="5" class="w-full bg-gray-900 border border-gray-600 rounded p-3 font-mono text-sm"></textarea></div>
                            <button onclick="saveSettings()" class="bg-blue-600 px-8 py-3 rounded font-bold w-full">保存设置</button>
                        </div>
                    </div>
                    <div id="tab-logs" class="tab-content hidden">
                        <div class="flex justify-between mb-4"><h3 class="font-bold">访问日志</h3><button onclick="loadLogs()" class="text-xs text-blue-400">刷新</button></div>
                        <div class="bg-gray-800 rounded-lg overflow-hidden"><table class="log-table"><thead><tr><th>时间</th><th>IP</th><th>内容</th></tr></thead><tbody id="logs-body"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PWD = "110110";
        // --- MockDB ---
        const MockDB = {
            data: { settings: { announcement: "预览模式", siteLogo: "", background_config: "[]" }, categories: [], sites: [], logs: [] },
            async handle(ep, method, body) {
                await new Promise(r=>setTimeout(r,50));
                if(ep==='settings'){ if(method==='POST'){Object.assign(this.data.settings, body);return{success:true}} return this.data.settings }
                if(ep==='categories'){ if(method==='POST'){this.data.categories.push({id:Date.now(),...body,displayOrder:this.data.categories.length});return{success:true}} if(method==='DELETE'){this.data.categories=this.data.categories.filter(c=>c.id!=ep.split('/')[1]);return{success:true}} return this.data.categories }
                if(ep.startsWith('sites')){ 
                    if(method==='POST'){this.data.sites.push({id:Date.now(),...body,visit_count:0});return{success:true}}
                    const id=parseInt(ep.split('/')[1]);
                    if(method==='PUT'){const i=this.data.sites.findIndex(s=>s.id==id);if(i!=-1)this.data.sites[i]={...this.data.sites[i],...body};return{success:true}}
                    if(method==='DELETE'){this.data.sites=this.data.sites.filter(s=>s.id!=id);return{success:true}}
                    return this.data.sites
                }
                if(ep==='logs') return this.data.logs;
                return {success:true};
            }
        };
        // --- API ---
        const api = {
            async req(ep, method='GET', data=null) {
                const isBlob = window.location.protocol === 'blob:' || window.location.href.startsWith('blob:');
                if(isBlob) return MockDB.handle(ep, method, data);
                try {
                    const res = await fetch(`/api/${ep}`, {method, headers:{'Content-Type':'application/json'}, body:data?JSON.stringify(data):null});
                    if(!res.ok) throw new Error();
                    return await res.json();
                } catch(e) { return MockDB.handle(ep, method, data); }
            },
            get:u=>api.req(u), post:(u,d)=>api.req(u,'POST',d), put:(u,d)=>api.req(u,'PUT',d), del:u=>api.req(u,'DELETE')
        };

        const state={sites:[],cats:[],settings:{},backgrounds:[],bgIndex:0};
        async function init() {
            const [s,c,set] = await Promise.all([api.get('sites'),api.get('categories'),api.get('settings')]);
            state.sites=s||[]; state.cats=c||[]; state.settings=set||{};
            try{ state.backgrounds = JSON.parse(state.settings.background_config||'[]'); }catch{ state.backgrounds=[]; }
            if(!state.backgrounds.length && state.settings.backgroundUrl) state.backgrounds=[state.settings.backgroundUrl];
            renderApp(); startSlideshow();
        }

        function renderApp() {
            if(state.settings.siteLogo) { document.getElementById('site-logo').src=state.settings.siteLogo; document.getElementById('site-logo').classList.remove('hidden'); }
            if(state.backgrounds.length) document.body.style.backgroundImage=`url('${state.backgrounds[0]}')`;
            if(state.settings.announcement) { document.getElementById('marquee-text').textContent=state.settings.announcement; document.getElementById('marquee-wrapper').classList.remove('hidden'); }
            
            const side=document.getElementById('sidebar-nav'), top=document.getElementById('topbar-nav'), mob=document.getElementById('mobile-nav-content');
            side.innerHTML=''; top.innerHTML=''; mob.innerHTML='';
            state.cats.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)).forEach(c=>{
                const b = document.createElement('a');
                b.className="block px-4 py-2 rounded text-gray-300 hover:bg-white/10 cursor-pointer text-sm";
                b.innerHTML=`<i data-lucide="folder" class="inline w-4 h-4 mr-2"></i>${c.name}`;
                b.onclick=()=>document.getElementById(`cat-${c.id}`)?.scrollIntoView({behavior:'smooth'});
                if(c.type==='sidebar'){ side.appendChild(b); mob.appendChild(b.cloneNode(true)); }
                else { b.className="px-4 py-1.5 bg-gray-800 hover:bg-gray-700 rounded-full text-xs border border-gray-700 cursor-pointer"; top.appendChild(b); }
            });

            const con=document.getElementById('sites-container'); con.innerHTML='';
            state.cats.forEach(c=>{
                const sites = state.sites.filter(s=>s.categoryId==c.id).sort((a,b)=>(a.display_order||0)-(b.display_order||0));
                if(!sites.length) return;
                const div=document.createElement('div'); div.id=`cat-${c.id}`;
                div.innerHTML=`<h3 class="text-xl font-bold mb-5 pl-2 border-l-4 border-blue-500">${c.name}</h3><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"></div>`;
                const grid=div.querySelector('div');
                sites.forEach(s=>{
                    const a=document.createElement('a'); a.href=s.url; a.target="_blank"; a.className="glass-card p-4 rounded-xl flex items-center gap-4 hover:-translate-y-1 transition-all";
                    a.onclick=()=>api.post(`visit/${s.id}`);
                    a.innerHTML=`<img src="${s.icon||''}" class="w-10 h-10 rounded object-contain bg-gray-900" onerror="this.src='https://placehold.co/40'"><div class="min-w-0"><h4 class="font-bold text-sm truncate text-blue-400">${s.name}</h4><p class="text-xs text-gray-500 truncate">${s.description||''}</p></div>`;
                    grid.appendChild(a);
                });
                con.appendChild(div);
            });
            
            const freq=[...state.sites].sort((a,b)=>(b.visit_count||0)-(a.visit_count||0)).slice(0,8);
            if(freq.length) {
                document.getElementById('frequent-section').classList.remove('hidden');
                document.getElementById('frequent-grid').innerHTML=freq.map(s=>`<a href="${s.url}" target="_blank" class="glass-card p-3 rounded flex flex-col items-center hover:bg-white/10"><img src="${s.icon}" class="w-8 h-8 rounded mb-2"><span class="text-xs truncate w-full text-center">${s.name}</span></a>`).join('');
            }
            lucide.createIcons();
        }

        function startSlideshow(){ if(state.bgInterval) clearInterval(state.bgInterval); if(state.backgrounds.length<2)return; const next=()=>{state.bgIndex=(state.bgIndex+1)%state.backgrounds.length;document.body.style.backgroundImage=`url('${state.backgrounds[state.bgIndex]}')`;}; state.bgInterval=setInterval(next,5000); }

        function openAdmin(){document.getElementById('admin-modal').classList.add('active');}
        function closeAdmin(){document.getElementById('admin-modal').classList.remove('active');document.getElementById('admin-login').classList.remove('hidden');document.getElementById('admin-panel').classList.add('hidden');}
        function login(){ if(document.getElementById('admin-pwd').value===ADMIN_PWD){document.getElementById('admin-login').classList.add('hidden');document.getElementById('admin-panel').classList.remove('hidden');renderAdminUI();}else alert("密码错误"); }
        function showTab(id){ document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+id).classList.remove('hidden'); document.querySelectorAll('.admin-tab').forEach(e=>e.classList.remove('active-tab','text-blue-400','bg-gray-800')); event.target.classList.add('active-tab','text-blue-400','bg-gray-800'); }

        function renderAdminUI(){
            const sel=document.getElementById('site-cat'); sel.innerHTML=state.cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('admin-site-list').innerHTML=state.sites.map(s=>`<div class="flex justify-between bg-gray-800 p-2 rounded mb-1 border border-gray-700"><span class="truncate w-1/3">${s.name}</span><div><button onclick="editSite(${s.id})" class="text-xs text-blue-400 mr-2">编辑</button><button onclick="delSite(${s.id})" class="text-xs text-red-400">删除</button></div></div>`).join('');
            document.getElementById('admin-cat-list').innerHTML=state.cats.map(c=>`<div class="flex justify-between bg-gray-800 p-2 rounded mb-1 border border-gray-700"><span>${c.name} <span class="text-xs bg-gray-700 px-1 rounded">${c.type}</span></span><button onclick="delCat(${c.id})" class="text-xs text-red-400">删除</button></div>`).join('');
            document.getElementById('set-marquee').value=state.settings.announcement||'';
            document.getElementById('set-logo').value=state.settings.siteLogo||'';
            document.getElementById('set-logo-preview').src=state.settings.siteLogo||'';
            document.getElementById('set-bg').value=(state.backgrounds||[]).join('\n');
        }

        async function saveSettings(){
            const bg=document.getElementById('set-bg').value.split('\n').map(s=>s.trim()).filter(Boolean);
            const data={ announcement:document.getElementById('set-marquee').value, siteLogo:document.getElementById('set-logo').value, background_config:JSON.stringify(bg) };
            await api.post('settings', data); alert("保存成功"); location.reload();
        }

        document.getElementById('site-form').onsubmit=async(e)=>{e.preventDefault(); const id=document.getElementById('site-id').value; const data={categoryId:document.getElementById('site-cat').value,name:document.getElementById('site-name').value,url:document.getElementById('site-url').value,icon:document.getElementById('site-icon').value,description:document.getElementById('site-desc').value}; if(id)await api.put(`sites/${id}`,data);else await api.post('sites',data); resetForm(); init(); renderAdminUI();};
        window.editSite=id=>{const s=state.sites.find(x=>x.id==id);if(!s)return;document.getElementById('site-id').value=s.id;document.getElementById('site-cat').value=s.categoryId;document.getElementById('site-name').value=s.name;document.getElementById('site-url').value=s.url;document.getElementById('site-icon').value=s.icon;document.getElementById('site-desc').value=s.description;document.getElementById('icon-preview').src=s.icon;};
        window.delSite=async id=>{if(confirm('删除?'))await api.del(`sites/${id}`);init();renderAdminUI();};
        window.addCat=async()=>{const n=document.getElementById('cat-name').value;if(!n)return;await api.post('categories',{name:n,type:document.getElementById('cat-type').value});document.getElementById('cat-name').value='';init();renderAdminUI();};
        window.delCat=async id=>{if(confirm('删除分类?'))await api.del(`categories/${id}`);init();renderAdminUI();};
        window.resetForm=()=>{document.getElementById('site-form').reset();document.getElementById('site-id').value='';document.getElementById('icon-preview').src='';};
        
        document.getElementById('site-url').onblur=function(){if(this.value&&!document.getElementById('site-icon').value){try{const h=new URL(this.value).hostname;document.getElementById('site-icon').value=`https://www.google.com/s2/favicons?domain=${h}&sz=64`;document.getElementById('icon-preview').src=document.getElementById('site-icon').value;}catch{}}};
        document.getElementById('site-icon').oninput=function(){document.getElementById('icon-preview').src=this.value};
        document.getElementById('set-logo').oninput=function(){document.getElementById('set-logo-preview').src=this.value};
        document.getElementById('search-input').oninput=function(){const t=this.value.toLowerCase();document.querySelectorAll('.glass-card').forEach(c=>c.style.display=c.innerText.toLowerCase().includes(t)?'flex':'none')};
        
        window.loadLogs=async()=>{const l=await api.get('logs');document.getElementById('logs-body').innerHTML=l.map(x=>`<tr><td class="text-gray-400 text-xs">${new Date(x.created_at).toLocaleString()}</td><td class="text-blue-300 text-xs font-mono">${x.ip_address}</td><td class="text-xs">${x.site_name||'-'}</td></tr>`).join('')};
        
        function toggleMobileSidebar(){ const s=document.getElementById('mobile-sidebar'); s.classList.toggle('hidden'); }
        document.getElementById('mobile-menu-toggle').onclick=toggleMobileSidebar;

        init(); lucide.createIcons();
    </script>
</body>
</html>
